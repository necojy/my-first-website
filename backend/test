# ... (å‰é¢çš„ driverè¨­å®š èˆ‡ ç™»å…¥éƒ¨åˆ†ä¿æŒä¸è®Š) ...

        # --- ç™»å…¥ä¸¦åˆ‡æ›åˆ°ã€Œé–€å¸‚äº¤æ˜“ç´€éŒ„ã€å¾Œ ---
        
        # ğŸŒŸ ä¿®æ”¹ 1: æ›´å¼·å¤§çš„ç„¡é™æ²å‹•é‚è¼¯ (é˜²èª¤åˆ¤ã€é˜²å¡ä½)
        print("é–‹å§‹å¼·åŠ›æ²å‹•æ¨¡å¼...")
        
        last_height = driver.execute_script("return document.body.scrollHeight")
        retries = 0
        max_retries = 3  # çµ¦äºˆ 3 æ¬¡é‡è©¦æ©Ÿæœƒ
        
        while True:
            # 1. ç‚ºäº†è§¸ç™¼æŸäº›æ‡¶åŠ è¼‰ï¼Œå…ˆå¾€ä¸Šæ²ä¸€é»é»ï¼Œå†æ²åˆ°åº•
            driver.execute_script("window.scrollTo(0, document.body.scrollHeight - 300);")
            time.sleep(0.5)
            driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
            
            # 2. ç­‰å¾…è¼‰å…¥ (å› ç‚ºåœ–ç‰‡å¤šï¼Œçµ¦ç¨é•·ä¸€é»çš„æ™‚é–“)
            time.sleep(3)
            
            new_height = driver.execute_script("return document.body.scrollHeight")
            
            if new_height == last_height:
                retries += 1
                print(f"âš ï¸ é«˜åº¦æœªè®ŠåŒ–ï¼Œé‡è©¦è¨ˆæ•¸: {retries}/{max_retries}")
                
                if retries >= max_retries:
                    print("âœ… ç¢ºèªå·²åˆ°é”é é¢æœ€åº•éƒ¨ (æˆ–å¹´ä»½è³‡æ–™å·²è®€å®Œ)")
                    break
                
                # ç­‰å¾…ä¹…ä¸€é»å†è©¦ä¸€æ¬¡
                time.sleep(2)
            else:
                # é«˜åº¦æœ‰è®ŠåŒ–ï¼Œé‡ç½®è¨ˆæ•¸å™¨
                retries = 0
                last_height = new_height
                print("â¬ æˆåŠŸè¼‰å…¥æ›´å¤šè³‡æ–™...")

        # --- è§£æèˆ‡çµ±è¨ˆ (æ ¹æ“šä½ æä¾›çš„å®Œæ•´ HTML å„ªåŒ–) ---
        print("é–‹å§‹è§£æ HTML...")
        page_html = driver.page_source
        soup = BeautifulSoup(page_html, 'html.parser')
        
        # æ ¹æ“š HTMLï¼Œæ¯ä¸€å€‹è¨‚å–®å€å¡Šæ˜¯ e2-my-account-order-history-item
        items = soup.find_all('e2-my-account-order-history-item')
        
        raw_data = [] 
        
        for item in items:
            # 1. æŠ“å–è¨‚å–®é ­éƒ¨è³‡è¨Š (æ—¥æœŸã€åº—åã€ç¸½é‡‘é¡)
            data_ul = item.find('ul', class_='desktop-order-data')
            if data_ul:
                lis = data_ul.find_all('li')
                if len(lis) >= 3:
                    full_date_str = lis[0].text.strip() # ä¾‹å¦‚: 15-Feb-2026 16:47:48
                    store_name = lis[1].text.strip()    # ä¾‹å¦‚: å—æŠ•2
                    amount_str = lis[2].text.strip()    # ä¾‹å¦‚: $1,300
                    
                    # 2. æŠ“å–è©²è¨‚å–®ä¸‹çš„ã€Œæ‰€æœ‰å•†å“ç´°é …ã€
                    # HTML çµæ§‹: div.order-details -> div.order-detail-product -> div.product-name
                    products_list = []
                    details_divs = item.find_all('div', class_='order-details')
                    
                    for detail in details_divs:
                        p_name_div = detail.find('div', class_='product-name')
                        p_qty_div = detail.find('div', class_='product-quantity')
                        
                        if p_name_div:
                            p_name = p_name_div.text.strip()
                            # éæ¿¾æ‰ä¸éœ€è¦çš„é …ç›® (çœ‹éœ€æ±‚)
                            if "Missing item sales" in p_name or "ç´™æœ¬ç™¼ç¥¨" in p_name:
                                continue
                                
                            qty = p_qty_div.text.strip().replace("æ•¸é‡:", "").strip() if p_qty_div else "1"
                            products_list.append(f"{p_name} x{qty}")

                    raw_data.append({
                        "æ—¥æœŸ": full_date_str,
                        "åº—å": store_name,
                        "é‡‘é¡": amount_str,
                        "è³¼è²·å•†å“": products_list  # é€™è£¡å¢åŠ äº†å•†å“æ¸…å–®
                    })

        driver.quit()
        
        return {
            "message": "è³‡æ–™æŠ“å–å®Œæˆï¼", 
            "è³‡æ–™ç¸½ç­†æ•¸": len(raw_data), 
            "è©³ç´°æ¸…å–®": raw_data
        }