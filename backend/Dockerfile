# 1. ä½¿ç”¨å®˜æ–¹çš„ Python åŸºç¤ç³»çµ±
FROM python:3.10-slim

# 2. å®‰è£ç³»çµ±å¿…å‚™çš„åº•å±¤å…ƒä»¶èˆ‡ Google Chrome
RUN apt-get update && apt-get install -y wget unzip curl gnupg \
    && curl -fSsL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor | tee /usr/share/keyrings/google-chrome.gpg > /dev/null \
    && sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list' \
    && apt-get update && apt-get install -y google-chrome-stable \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 3. ğŸŒŸã€HF å°ˆå±¬è¦å®šã€‘ï¼šå»ºç«‹é root ä½¿ç”¨è€… (ID: 1000)
RUN useradd -m -u 1000 user
USER user
ENV HOME=/home/user \
    PATH=/home/user/.local/bin:$PATH

# 4. è¨­å®šå·¥ä½œè³‡æ–™å¤¾
WORKDIR $HOME/app

# 5. è¤‡è£½ä¸¦å®‰è£ Python å¥—ä»¶ (çµ¦äºˆ user æ¬Šé™)
COPY --chown=user requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 6. è¤‡è£½ä½ çš„æ‰€æœ‰å¾Œç«¯ç¨‹å¼ç¢¼åˆ°ç³»çµ±å…§
COPY --chown=user . .

# 7. ğŸŒŸã€HF å°ˆå±¬è¦å®šã€‘ï¼šå•Ÿå‹• FastAPI ä¼ºæœå™¨çš„å¤§è…¦ï¼Œå¤§é–€å¿…é ˆé–‹åœ¨ 7860
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "7860"]